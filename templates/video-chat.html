<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Video Chat | Smarthub</title>
        <link rel="stylesheet" href="{{ url_for('static', filename='css/video-chat.css') }}" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    </head>
    <body>
        <header class="video-chat-header">
            <div class="logo-nav">
                <nav>
                    <a href="#">Home</a>
                    <a href="#" class="active">Video Chat</a>
                    <a href="#">Articles</a>
                </nav>
            </div>
            <div class="user-avatar">K</div>
        </header>

        <main class="video-chat-main">
            <!-- Video Area -->
            <section class="video-area">
                <div class="main-video-container">
                    <div class="main-video">
                        <div class="video-stream">
                            <img
                                src="{{ url_for('static', filename='images/3.gif') }}"
                                alt="Main Video Stream"
                                class="video-image"
                            />
                        </div>
                        <div class="video-overlay">
                            <div class="participant-name">Karina - Aespa</div>
                            <div class="video-controls">
                                <button class="video-control-btn"><i class="fa-solid fa-expand"></i></button>
                                <button class="video-control-btn"><i class="fa-solid fa-cog"></i></button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="participants-grid">
                    <div class="participant-video">
                        <div class="video-stream small">
                            <img
                                src="{{ url_for('static', filename='images/jisoo.gif') }}"
                                alt="Jisoo"
                                class="video-image"
                            />
                        </div>
                        <div class="participant-name">Jisoo - Blackpink</div>
                    </div>
                    <div class="participant-video">
                        <div class="video-stream small">
                            <img
                                src="{{ url_for('static', filename='images/Yeji.gif') }}"
                                alt="Yeji"
                                class="video-image"
                            />
                        </div>
                        <div class="participant-name">Yeji - Itzy</div>
                    </div>
                    <div class="participant-video">
                        <div class="video-stream small">
                            <img
                                src="{{ url_for('static', filename='images/yunjin.gif') }}"
                                alt="Yunjin"
                                class="video-image"
                            />
                        </div>
                        <div class="participant-name">Yun-jin - Le Sserafim</div>
                    </div>
                    <div class="participant-video">
                        <div class="video-stream small">
                            <img
                                src="{{ url_for('static', filename='images/nayeon.gif') }}"
                                alt="Nayeon"
                                class="video-image"
                            />
                        </div>
                        <div class="participant-name">Nayeon - Twice</div>
                    </div>
                    <div class="participant-video">
                        <div class="video-stream small">
                            <img
                                src="{{ url_for('static', filename='images/yeri.gif') }}"
                                alt="Yeri"
                                class="video-image"
                            />
                        </div>
                        <div class="participant-name">Yeri - Red Velvet</div>
                    </div>
                </div>

                <!-- Meeting Controls Toolbar -->
                <div class="meeting-controls-toolbar">
                    <div class="meeting-controls">
                        <button class="control-btn"><i class="fa-solid fa-microphone"></i></button>
                        <button class="control-btn"><i class="fa-solid fa-video"></i></button>
                        <button class="control-btn"><i class="fa-solid fa-desktop"></i></button>
                        <button class="control-btn"><i class="fa-solid fa-users"></i></button>
                        <button class="control-btn"><i class="fa-solid fa-ellipsis-h"></i></button>
                        <button class="control-btn end-call"><i class="fa-solid fa-phone-slash"></i></button>
                    </div>
                </div>
            </section>

            <!-- Chat Sidebar -->
            <section class="chat-sidebar">
                <div class="chat-header">
                    <h3><i class="fa-solid fa-comments"></i> Meeting Chat</h3>
                    <button class="minimize-btn"><i class="fa-solid fa-minus"></i></button>
                </div>

                <div class="chat-messages">
                    <div class="message bot">
                        <div class="bot-icon"><i class="fa-solid fa-circle-arrow-up"></i></div>
                        <div class="bubble">Annyeonghaseyo! Welcome everyone! I'm Karina from Aespa.</div>
                    </div>
                    <!-- <div class="message user">
                        <div class="bubble">Annyeonghaseyo! ðŸ‘‹</div>
                    </div>
                    <div class="message user">
                        <div class="bubble">Can everyone hear me clearly?</div>
                    </div> -->
                </div>

                <form class="chat-input-bar">
                    <input type="text" placeholder="Type a message..." autocomplete="off" />
                    <button type="submit"><i class="fa-solid fa-paper-plane"></i></button>
                </form>
            </section>
        </main>
    </body>
</html>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.querySelector('.chat-input-bar');
        const input = form.querySelector('input[type="text"]');
        const messagesContainer = document.querySelector('.chat-messages');

        function appendMessage(content, sender = 'user') {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message ' + sender;
            if (sender === 'bot') {
                msgDiv.innerHTML = `
                    <div class="bot-icon"><i class="fa-solid fa-circle-arrow-up"></i></div>
                    <div class="bubble">${content}</div>
                `;
            } else {
                msgDiv.innerHTML = `<div class="bubble">${content}</div>`;
            }
            messagesContainer.appendChild(msgDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            return msgDiv;
        }

        function removeLoadingIndicator() {
            const messages = messagesContainer.querySelectorAll('.message.bot');
            for (let i = messages.length - 1; i >= 0; i--) {
                const bubble = messages[i].querySelector('.bubble');
                if (bubble && bubble.textContent === '...') {
                    messages[i].remove();
                    break;
                }
            }
        }

        form.addEventListener('submit', async function (e) {
            e.preventDefault();
            const userMsg = input.value.trim();
            if (!userMsg) return;

            appendMessage(userMsg, 'user');
            input.value = '';
            appendMessage('...', 'bot');

            try {
                const res = await fetch('/aws-bedrock', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: userMsg,
                        system_prompt:
                            'You are a helpful assistant. Act like Karina from Aespa. In this situation, Karina is an interviewee looking for work',
                    }),
                });
                const data = await res.json();

                removeLoadingIndicator();
                appendMessage(data.response, 'bot');
            } catch (err) {
                console.error('Error:', err);
                removeLoadingIndicator();
                appendMessage('Sorry, there was an error. Please try again.', 'bot');
            }
        });

        // Video controls functionality
        const controlBtns = document.querySelectorAll('.control-btn');
        controlBtns.forEach((btn) => {
            btn.addEventListener('click', function () {
                this.classList.toggle('active');
            });
        });

        // End call button
        const endCallBtn = document.querySelector('.end-call');
        endCallBtn.addEventListener('click', function () {
            if (confirm('Are you sure you want to end the call?')) {
                // Handle end call logic
                console.log('Ending call...');
            }
        });
    });
</script>
