{% extends 'base.html' %} {% block head %}
<title>Document Management</title>
<link rel="stylesheet" href="{{ url_for('static', filename='css/document-list.css') }}" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
{% endblock %} {% block body %}
<div class="container">
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="logo">E</div>
        </div>
        <nav class="sidebar-nav">
            <ul>
                <li>
                    <a href="#" class="active"><i class="fas fa-home"></i></a>
                </li>
                <li>
                    <a href="#"><i class="fas fa-folder"></i></a>
                </li>
            </ul>
        </nav>
    </aside>
    <main class="main-content">
        <header class="main-header">
            <h1>Document Management</h1>
            <div class="user-profile">AA</div>
        </header>
        <div class="toolbar">
            <div class="search-container">
                <i class="fas fa-search"></i>
                <input type="text" placeholder="Search for a file or folder" />
            </div>
            <button class="add-new-btn"><i class="fas fa-plus"></i> Add new</button>
        </div>
        <div class="document-list">
            <div class="list-header">
                <div class="header-item name">Name <i class="fas fa-arrow-down"></i></div>
                <div class="header-item type">Type</div>
                <div class="header-item size">Size <i class="fas fa-arrow-down"></i></div>
                <div class="header-item date-uploaded">Date Uploaded <i class="fas fa-arrow-down"></i></div>
                <div class="header-item date-modified">Date Modified <i class="fas fa-arrow-down"></i></div>
                <div class="header-item actions"></div>
            </div>
            {% if not documents %}
            <div class="empty-list">
                <div class="empty-list-icon"></div>
                <h2>No documents found</h2>
                <p>Parsed documents will be displayed here</p>
                <button class="add-new-secondary-btn"><i class="fas fa-plus"></i> Add new</button>
            </div>
            {% else %} {% for doc in documents %}
            <div class="list-item" data-id="{{ doc.id }}" data-name="{{ doc.name }}">
                <div class="item-cell name">
                    {% if doc.type == 'Folder' %}
                    <i class="fas fa-folder"></i>
                    {% else %}
                    <i class="fas fa-file-alt"></i>
                    {% endif %}
                    <span>{{ doc.name }}</span>
                </div>
                <div class="item-cell type">
                    {% if doc.type == 'Folder' %} Folder {% elif 'wordprocessingml' in doc.type %} DOCX {% else %} {{
                    doc.type.split('/')[-1] | upper if '/' in doc.type else doc.type | upper }} {% endif %}
                </div>
                <div class="item-cell size">{{ "%.2f" | format(doc.size / (1024*1024)) }} MB</div>
                <div class="item-cell date-uploaded">
                    {{ doc.date_uploaded.strftime('%a, %d %b %Y %H:%M:%S') }}
                    <span class="modifier">Juan dela Cruz</span>
                </div>
                <div class="item-cell date-modified">
                    {% if doc.date_modified %} {{ doc.date_modified.strftime('%a, %d %b %Y %H:%M:%S') }}
                    <span class="modifier">Maria Clara</span>
                    {% else %} Not available {% endif %}
                </div>
                <div class="item-cell actions">
                    <i class="fas fa-ellipsis-v action-btn"></i>
                    <div class="action-popup">
                        <a href="#" class="edit-btn">Edit</a>
                        <a href="#" class="delete-btn">Delete</a>
                    </div>
                </div>
            </div>
            {% endfor %} {% endif %}
        </div>
        <footer class="main-footer">
            <div class="pagination">
                <button disabled>&lt;</button>
                <button class="active">1</button>
                <button>&gt;</button>
            </div>
            <div class="page-size-selector">
                <select>
                    <option>10 / page</option>
                </select>
            </div>
            <div class="item-count">
                1-{{ documents|length if documents else 0 }} of {{ documents|length if documents else 0 }} items
            </div>
        </footer>
    </main>
</div>

<div id="edit-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn">&times;</span>
        <h2>Edit Document Name</h2>
        <form id="edit-form">
            <input type="hidden" id="edit-doc-id" name="id" />
            <div class="form-group">
                <label for="edit-doc-name">Document Name</label>
                <input type="text" id="edit-doc-name" name="name" required />
            </div>
            <button type="submit" class="save-btn">Save Changes</button>
        </form>
    </div>
</div>

<div id="upload-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn">&times;</span>
        <h2>Add new document</h2>
        <form id="upload-form">
            <p>Select a file to get its details.</p>
            <input type="file" id="file-input" required />
            <button type="submit" class="upload-btn">Add Document</button>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const uploadModal = document.getElementById('upload-modal');
        const editModal = document.getElementById('edit-modal');
        const modals = document.querySelectorAll('.modal');

        const openModal = (modal) => {
            if (modal) modal.style.display = 'block';
        };

        const closeModal = (modal) => {
            if (modal) {
                modal.style.display = 'none';
                const form = modal.querySelector('form');
                if (form) form.reset();
            }
        };

        // General modal close functionality
        modals.forEach((modal) => {
            const closeBtn = modal.querySelector('.close-btn');
            closeBtn.addEventListener('click', () => closeModal(modal));
        });

        window.addEventListener('click', (event) => {
            modals.forEach((modal) => {
                if (event.target == modal) {
                    closeModal(modal);
                }
            });
        });

        // Upload modal functionality
        document.querySelectorAll('.add-new-btn, .add-new-secondary-btn').forEach((btn) => {
            btn.addEventListener('click', () => openModal(uploadModal));
        });

        const uploadForm = document.getElementById('upload-form');
        const fileInput = document.getElementById('file-input');
        uploadForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const file = fileInput.files[0];
            if (!file) {
                alert('Please select a file.');
                return;
            }
            const formData = new FormData();
            formData.append('name', file.name);
            formData.append('size', file.size);
            formData.append('type', file.type || 'unknown');
            try {
                const response = await fetch('/documents', {
                    method: 'POST',
                    body: formData,
                });
                if (response.ok) {
                    window.location.href = '/documents';
                } else {
                    alert('There was an issue adding your document.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while adding the document.');
            }
        });

        // Action popup functionality
        document.querySelectorAll('.action-btn').forEach((btn) => {
            btn.addEventListener('click', (event) => {
                event.stopPropagation();
                // Close all other popups
                document.querySelectorAll('.action-popup').forEach((popup) => {
                    if (popup !== btn.nextElementSibling) {
                        popup.classList.remove('show');
                    }
                });
                // Toggle current popup
                const popup = btn.nextElementSibling;
                popup.classList.toggle('show');
            });
        });

        window.addEventListener('click', () => {
            document.querySelectorAll('.action-popup').forEach((popup) => {
                popup.classList.remove('show');
            });
        });

        // Edit functionality
        const editForm = document.getElementById('edit-form');
        const editDocIdInput = document.getElementById('edit-doc-id');
        const editDocNameInput = document.getElementById('edit-doc-name');

        document.querySelectorAll('.edit-btn').forEach((btn) => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                const listItem = btn.closest('.list-item');
                const docId = listItem.dataset.id;
                const docName = listItem.dataset.name;

                editDocIdInput.value = docId;
                editDocNameInput.value = docName;
                openModal(editModal);
            });
        });

        editForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const docId = editDocIdInput.value;
            const newName = editDocNameInput.value;

            try {
                const response = await fetch(`/documents/edit/${docId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: newName }),
                });

                if (response.ok) {
                    window.location.href = '/documents';
                } else {
                    alert('There was an issue updating the document name.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while updating the document name.');
            }
        });

        // Delete functionality
        document.querySelectorAll('.delete-btn').forEach((btn) => {
            btn.addEventListener('click', async (e) => {
                e.preventDefault();
                if (confirm('Are you sure you want to delete this document?')) {
                    const listItem = btn.closest('.list-item');
                    const docId = listItem.dataset.id;

                    try {
                        const response = await fetch(`/documents/delete/${docId}`, {
                            method: 'DELETE',
                        });

                        if (response.ok) {
                            listItem.remove();
                            // Optionally, update the total item count display
                        } else {
                            alert('There was an issue deleting the document.');
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        alert('An error occurred while deleting the document.');
                    }
                }
            });
        });
    });
</script>
{% endblock %}
